/*! angular-lookup-directive 29-11-2015 */

!function () {
    "use strict";
    var a = ["$http", "$q"], b = function (a, b) {
        var c = '<div ng-cloak><input type="text" ng-model="value" class="ruaghain-lookup" ng-keyup="onInputKeyUp($event)"><ul ng-keydown="onListKeyDown($event)"><li ng-repeat="record in foundRecords"><a href="" ng-click="onItemSelect(record)" ng-keyup="onItemKeyUp($event, record)">{{record[lookupTextField]}}</a></li></ul></div><div ng-show="addRecord"><button id="btnSave" ng-click="saveLookup()">Save</button><button id="btnCancel" ng-click="cancel()">Cancel</button></div>', d = function (c, d, e, f) {
            if (f) {
                var g = d.find("input"), h = void 0 !== e.$attr.required;
                f.$formatters.push(function (a) {
                    return a ? {id: a[c.lookupValueField], value: a[c.lookupTextField]} : void 0
                }), f.$parsers.push(function (a) {
                    if (a) {
                        var b = a[c.lookupValueField], d = a[c.lookupTextField];
                        return {id: b, value: d}
                    }
                    return {id: "", value: ""}
                }), f.$validators.requiredItemSelected = function (a, b) {
                    var d = a || b;
                    return h ? !f.$isEmpty(d[c.lookupValueField]) : !0
                }, f.$render = function () {
                    c.id = f.$viewValue.id, c.value = f.$viewValue.value
                }, c.onItemSelect = function (a) {
                    g.val(a[c.lookupTextField]), f.$setViewValue(a), c.itemSelected = !0, c.clearResults()
                }, c.onInputKeyUp = function (a) {
                    var b = a.which;
                    if (27 === b || 40 != b && f.$isEmpty(g.val()))c.clearResults(), c.itemSelected = !1, f.$setViewValue(null); else if (b > 64 && 91 > b || b > 96 && 123 > b || 40 === b) {
                        if (c.searching && 40 === b)return;
                        c.search()
                    }
                }, c.onItemKeyUp = function (a, b) {
                    var d = a.which;
                    13 === d && c.onItemSelect(b)
                }, c.onListKeyDown = function (a) {
                    if (a.preventDefault(), 27 === a.which && c.clearResults(), 40 == a.which) {
                        var b = a.target.parentElement.nextElementSibling;
                        b ? b.firstChild.focus() : a.target.parentElement.parentElement.firstElementChild.focus()
                    } else if (38 == a.which) {
                        var d = a.target.parentElement.previousElementSibling;
                        d ? d.firstChild.focus() : a.target.parentElement.parentElement.lastElementChild.focus()
                    }
                }, c.clearResults = function () {
                    c.foundRecords = [], c.addRecord = !1, c.searching = !1
                }, c.search = function () {
                    c.searching = !0, c.findRestData(g).then(function (a) {
                        c.addRecord = c.lookupAllowInsert && ("undefined" == typeof a || 0 === a.length), a && 1 == a.length ? c.onItemSelect(a[0]) : c.foundRecords = a
                    })
                }, c.saveLookup = function () {
                    var d = g.val(), e = c.lookupDatasource().baseUrl, h = '{"' + c.lookupTextField + '":"' + d + '"}', i = b.defer();
                    a.post(e, h).then(function (a) {
                        c.getResource(a.headers("location")).then(function (a) {
                            f.$setViewValue(a), c.clearResults()
                        })
                    }, function (a) {
                        throw i.reject(a), new Error("There was an error saving the record: " + a.data.message)
                    })
                }, c.cancel = function () {
                    c.clearResults()
                }, c.getResource = function (c) {
                    var d = b.defer();
                    return a.get(c).then(function (a) {
                        d.resolve(a.data)
                    }, function (a) {
                        throw d.reject(a), new Error("There was an error looking up information")
                    }), d.promise
                }
            }
        }, e = ["$scope", function (c) {
            c.searching = !1, c.itemSelected = !1, c.lookupAllowInsert = angular.isDefined(c.lookupAllowInsert) ? c.lookupAllowInsert : !1, c.findRestData = function (c) {
                var d = b.defer(), e = this.lookupDatasource(), f = c.val(), g = encodeURIComponent("%" + f + "%");
                return a.get(e.baseUrl + e.searchUrl + g).then(function (a) {
                    e.payload(a.data) ? d.resolve(e.payload(a.data)) : d.resolve()
                }, function (a) {
                    throw d.reject(a), new Error("There was an error looking up information")
                }), d.promise
            }
        }];
        return {
            restrict: "E",
            scope: {lookupDatasource: "&", lookupTextField: "@", lookupValueField: "@", lookupAllowInsert: "=?"},
            require: "ngModel",
            template: c,
            link: d,
            controller: e
        }
    };
    b.$inject = a, angular.module("ruaghain.lookup-directive", []).directive("customLookup", b)
}();
//# sourceMappingURL=angular-lookup-directive.min.js.map